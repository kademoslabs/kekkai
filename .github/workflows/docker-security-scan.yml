name: Docker Security Scan

on:
  pull_request:
    paths:
      - 'apps/kekkai/Dockerfile'
      - 'requirements/**'
      - 'pyproject.toml'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/kekkai/Dockerfile
          push: false
          load: true
          tags: kademoslabs/kekkai:pr-${{ github.event.pull_request.number }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: kademoslabs/kekkai:pr-${{ github.event.pull_request.number }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM,LOW
          timeout: 10m

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy-pr-scan

      - name: Run Trivy scan (JSON format for reporting)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: kademoslabs/kekkai:pr-${{ github.event.pull_request.number }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH,MEDIUM,LOW

      - name: Analyze scan results
        id: analyze
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "Critical: $CRITICAL"
          echo "High: $HIGH"
          echo "Medium: $MEDIUM"
          echo "Low: $LOW"

      - name: Comment PR with scan results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const critical = '${{ steps.analyze.outputs.critical }}';
            const high = '${{ steps.analyze.outputs.high }}';
            const medium = '${{ steps.analyze.outputs.medium }}';
            const low = '${{ steps.analyze.outputs.low }}';

            const total = parseInt(critical) + parseInt(high) + parseInt(medium) + parseInt(low);

            let statusEmoji = '‚úÖ';
            let statusText = 'No vulnerabilities detected';

            if (parseInt(critical) > 0 || parseInt(high) > 0) {
              statusEmoji = '‚ùå';
              statusText = 'CRITICAL or HIGH vulnerabilities detected';
            } else if (parseInt(medium) > 0) {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'Medium vulnerabilities detected';
            } else if (parseInt(low) > 0) {
              statusEmoji = 'üü°';
              statusText = 'Only low severity vulnerabilities detected';
            }

            const comment = `## ${statusEmoji} Docker Security Scan Results

            **Status**: ${statusText}

            | Severity | Count |
            |----------|-------|
            | üî¥ CRITICAL | ${critical} |
            | üü† HIGH | ${high} |
            | üü° MEDIUM | ${medium} |
            | üü¢ LOW | ${low} |
            | **Total** | **${total}** |

            ${parseInt(critical) > 0 || parseInt(high) > 0 ? '‚ö†Ô∏è **This PR introduces CRITICAL or HIGH severity vulnerabilities and should not be merged until they are resolved.**' : ''}

            ---
            <sub>Scanned Docker image: \`kademoslabs/kekkai:pr-${{ github.event.pull_request.number }}\`</sub>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check vulnerability threshold
        run: |
          CRITICAL=${{ steps.analyze.outputs.critical }}
          HIGH=${{ steps.analyze.outputs.high }}

          if [[ "$CRITICAL" -gt 0 ]] || [[ "$HIGH" -gt 0 ]]; then
            echo "‚ùå Found $CRITICAL CRITICAL and $HIGH HIGH vulnerabilities"
            echo "This PR cannot be merged until vulnerabilities are resolved"
            exit 1
          fi

          echo "‚úÖ No CRITICAL or HIGH vulnerabilities detected"

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: kademoslabs/kekkai:pr-${{ github.event.pull_request.number }}
          format: spdx-json
          output: sbom-pr.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-pr-${{ github.event.pull_request.number }}
          path: sbom-pr.spdx.json
          retention-days: 30
