version: 2.1

jobs:
  test_quick:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install tooling
          command: |
            python -m venv .venv
            . .venv/bin/activate
            make setup
      - run:
          name: CI gate (quick)
          command: |
            . .venv/bin/activate
            make ci-quick
      - run:
          name: Native mode tests
          command: |
            . .venv/bin/activate
            make native-test
      - run:
          name: SLSA provenance tests
          command: |
            . .venv/bin/activate
            make slsa-test
      - run:
          name: GitHub PR commenter tests
          command: |
            . .venv/bin/activate
            make github-test
      - run:
          name: Windows unit tests
          command: |
            . .venv/bin/activate
            make windows-unit
      - run:
          name: Chocolatey unit tests
          command: |
            . .venv/bin/activate
            make chocolatey-unit
      - run:
          name: Fix engine tests
          command: |
            . .venv/bin/activate
            make fix-test
      - run:
          name: Report and compliance tests
          command: |
            . .venv/bin/activate
            make report-test
      - run:
          name: pipx install test
          command: |
            . .venv/bin/activate
            make pipx-test
      - run:
          name: VS Code extension build
          command: |
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
            make vscode-build
      - run:
          name: VS Code extension lint
          command: |
            make vscode-lint
      - run:
          name: VS Code extension tests
          command: |
            make vscode-test

  test_full:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install tooling
          command: |
            python -m venv .venv
            . .venv/bin/activate
            make setup
            if ! command -v docker-compose >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose
            fi
      - run:
          name: CI gate
          command: |
            . .venv/bin/activate
            make ci
      - run:
          name: Windows tests
          command: |
            . .venv/bin/activate
            make windows-test
      - run:
          name: Chocolatey tests
          command: |
            . .venv/bin/activate
            make chocolatey-test
      - run:
          name: Docker security tests
          command: |
            . .venv/bin/activate
            make docker-security-test

  build_verification:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install tooling
          command: |
            python -m venv .venv
            . .venv/bin/activate
            make setup
      - run:
          name: Verify Build (Dry Run)
          command: |
            . .venv/bin/activate
            make release
      - run:
          name: Validate wheel artifacts
          command: |
            ls -la dist/*.whl
            test -f dist/*.whl || (echo "ERROR: No wheel file found" && exit 1)
      - run:
          name: Build Docker image
          command: |
            make docker-image
      - run:
          name: Test Docker wrapper
          command: |
            make docker-test

workflows:
  # Develop branch: Fast checks only (Linux)
  develop:
    jobs:
      - test_quick:
          filters:
            branches:
              only: develop

  # Main branch: Full Linux testing + build validation
  main:
    jobs:
      - test_full:
          filters:
            branches:
              only: main
      - build_verification:
          requires:
            - test_full
          filters:
            branches:
              only: main

  # Release workflow: Tests only
  # Actual publishing is handled by GitHub Actions (release-slsa.yml)
  release:
    jobs:
      - test_full:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
