# Deployment Guide

This guide covers deploying Kekkai Portal for self-hosted and on-premises environments.

---

## Deployment Options

| Option | Best For | Complexity |
|--------|----------|------------|
| **Docker Compose** | Small teams, evaluation | Low |
| **Kubernetes** | Large scale, HA requirements | Medium |
| **On-Premises** | Air-gapped, regulated industries | High |
| **Managed (Kademos Cloud)** | Zero maintenance | Lowest |

---

## Prerequisites

### System Requirements

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| **CPU** | 2 cores | 4+ cores |
| **RAM** | 4 GB | 8+ GB |
| **Disk** | 20 GB | 100+ GB SSD |
| **OS** | Linux (Ubuntu 22.04+, RHEL 8+) | Ubuntu 24.04 LTS |

### Software Requirements

- Docker 24+ and Docker Compose v2
- OpenSSL (for TLS certificate management)
- curl or wget (for health checks)

---

## Docker Compose Deployment

### Quick Start

```bash
# Clone the repository
git clone https://github.com/kademoslabs/kekkai-cli.git
cd kekkai-cli/apps/portal

# Generate secrets
./generate-secrets.sh

# Start the stack
docker compose up -d

# Check status
docker compose ps
```

### Architecture

The Docker Compose deployment includes:

```
┌─────────────────────────────────────────────────────────────────┐
│                        Docker Network                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐    ┌─────────┐    ┌─────────────────────────────┐ │
│  │  Nginx  │───>│ Portal  │───>│       DefectDojo            │ │
│  │  :80    │    │  :8000  │    │  ┌──────┐ ┌──────┐ ┌──────┐│ │
│  │  :443   │    │         │    │  │uwsgi │ │celery│ │celery││ │
│  └─────────┘    └─────────┘    │  │      │ │worker│ │beat  ││ │
│       │                        │  └──────┘ └──────┘ └──────┘│ │
│       │                        └─────────────────────────────┘ │
│       │                                      │                  │
│       │         ┌────────────────────────────┘                  │
│       │         │                                               │
│       │         v                                               │
│       │    ┌─────────┐    ┌─────────┐                          │
│       │    │Postgres │    │ Valkey  │                          │
│       │    │  :5432  │    │  :6379  │                          │
│       │    └─────────┘    └─────────┘                          │
│       │                                                         │
└───────┼─────────────────────────────────────────────────────────┘
        │
        v
   External Access
   (HTTP/HTTPS)
```

### Environment Configuration

Create `.env` file:

```bash
# Portal Configuration
PORTAL_HOST=0.0.0.0
PORTAL_PORT=8000
PORTAL_TENANT_STORE=/var/lib/kekkai-portal/tenants.json
PORTAL_UPLOAD_DIR=/var/lib/kekkai-portal/uploads

# DefectDojo Configuration
DOJO_VERSION=latest
DD_ADMIN_USER=admin
DD_ADMIN_PASSWORD=  # Generated by generate-secrets.sh
DD_SECRET_KEY=      # Generated by generate-secrets.sh
DD_CREDENTIAL_AES_256_KEY=  # Generated by generate-secrets.sh

# Database Configuration
DD_DATABASE_URL=postgresql://defectdojo:defectdojo@postgres:5432/defectdojo
DD_DATABASE_NAME=defectdojo
DD_DATABASE_USER=defectdojo
DD_DATABASE_PASSWORD=  # Generated by generate-secrets.sh

# Ports
PORTAL_HTTP_PORT=80
PORTAL_HTTPS_PORT=443
```

### Generate Secrets Script

```bash
#!/bin/bash
# generate-secrets.sh

set -e

generate_password() {
    openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 32
}

cat > .env << EOF
# Auto-generated secrets - DO NOT COMMIT

DD_ADMIN_PASSWORD=$(generate_password)
DD_SECRET_KEY=$(generate_password)
DD_CREDENTIAL_AES_256_KEY=$(generate_password)
DD_DATABASE_PASSWORD=$(generate_password)

# Copy other settings from .env.example
EOF

echo "Secrets generated in .env"
echo "Admin password: $(grep DD_ADMIN_PASSWORD .env | cut -d= -f2)"
```

### Start Services

```bash
# Start all services
docker compose up -d

# Wait for initialization (first run takes ~5 minutes)
docker compose logs -f initializer

# Verify all services healthy
docker compose ps
```

---

## TLS/HTTPS Configuration

### Option 1: Let's Encrypt (Recommended for Internet-facing)

```yaml
# docker-compose.override.yml
services:
  certbot:
    image: certbot/certbot
    volumes:
      - ./certs:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot
    command: certonly --webroot -w /var/www/certbot -d portal.example.com --agree-tos --email admin@example.com

  nginx:
    volumes:
      - ./certs:/etc/nginx/certs:ro
      - ./certbot-www:/var/www/certbot:ro
```

### Option 2: Self-Signed Certificate

```bash
# Generate self-signed certificate
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout ./certs/portal.key \
  -out ./certs/portal.crt \
  -subj "/CN=portal.example.com"
```

### Option 3: Corporate CA Certificate

Place your certificates:
```
apps/portal/certs/
├── portal.crt    # Server certificate
├── portal.key    # Private key
└── ca.crt        # CA certificate (optional)
```

### Nginx HTTPS Configuration

```nginx
# nginx.conf excerpt
server {
    listen 443 ssl http2;
    server_name portal.example.com;

    ssl_certificate /etc/nginx/certs/portal.crt;
    ssl_certificate_key /etc/nginx/certs/portal.key;

    # Modern TLS configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        proxy_pass http://portal:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## On-Premises Deployment

### Air-Gapped Installation

For environments without internet access:

#### 1. Pre-download Images

On a connected machine:

```bash
# Pull all required images
docker pull nginx:1.25-alpine
docker pull defectdojo/defectdojo-nginx:latest
docker pull defectdojo/defectdojo-django:latest
docker pull postgres:16-alpine
docker pull valkey/valkey:7.2-alpine

# Save to tar archive
docker save -o kekkai-portal-images.tar \
  nginx:1.25-alpine \
  defectdojo/defectdojo-nginx:latest \
  defectdojo/defectdojo-django:latest \
  postgres:16-alpine \
  valkey/valkey:7.2-alpine
```

#### 2. Transfer to Air-Gapped System

Copy `kekkai-portal-images.tar` via approved media.

#### 3. Load Images

```bash
docker load -i kekkai-portal-images.tar
```

#### 4. Deploy

```bash
docker compose up -d
```

### Firewall Configuration

Required ports:

| Port | Direction | Purpose |
|------|-----------|---------|
| 80/tcp | Inbound | HTTP (redirect to HTTPS) |
| 443/tcp | Inbound | HTTPS |
| 5432/tcp | Internal only | PostgreSQL |
| 6379/tcp | Internal only | Valkey (Redis) |

```bash
# Example: UFW configuration
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 5432/tcp  # Block external DB access
sudo ufw deny 6379/tcp  # Block external Redis access
```

---

## Environment Variables Reference

### Portal Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `PORTAL_HOST` | `127.0.0.1` | Bind address |
| `PORTAL_PORT` | `8000` | Internal port |
| `PORTAL_TENANT_STORE` | `/var/lib/kekkai-portal/tenants.json` | Tenant database |
| `PORTAL_UPLOAD_DIR` | System temp | Upload storage |
| `PORTAL_LOG_LEVEL` | `INFO` | Logging verbosity |
| `PORTAL_SESSION_SECRET` | Required | Session signing key |

### SAML Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `PORTAL_SAML_ENTITY_ID` | - | IdP Entity ID |
| `PORTAL_SAML_SSO_URL` | - | IdP SSO URL |
| `PORTAL_SAML_CERTIFICATE` | - | IdP certificate path |
| `PORTAL_SP_ENTITY_ID` | - | Portal SP Entity ID |
| `PORTAL_SP_ACS_URL` | - | Portal ACS URL |
| `PORTAL_SESSION_LIFETIME` | `28800` | Session duration (seconds) |

### DefectDojo Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `DD_ADMIN_USER` | `admin` | Admin username |
| `DD_ADMIN_PASSWORD` | Required | Admin password |
| `DD_SECRET_KEY` | Required | Django secret key |
| `DD_DATABASE_URL` | Required | PostgreSQL connection |
| `DOJO_URL` | `http://defectdojo:8080` | Internal Dojo URL |

---

## High Availability

### Load Balancer Configuration

For HA deployments, place a load balancer in front:

```
                    ┌─────────────────┐
                    │  Load Balancer  │
                    │   (HAProxy/     │
                    │    AWS ALB)     │
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           v                 v                 v
    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
    │  Portal 1   │   │  Portal 2   │   │  Portal 3   │
    └─────────────┘   └─────────────┘   └─────────────┘
           │                 │                 │
           └─────────────────┼─────────────────┘
                             │
                             v
                    ┌─────────────────┐
                    │  Shared State   │
                    │  (PostgreSQL    │
                    │   Cluster)      │
                    └─────────────────┘
```

### Session Affinity

If using file-based sessions, enable sticky sessions:

```yaml
# HAProxy example
backend portal
    balance roundrobin
    cookie SERVERID insert indirect nocache
    server portal1 10.0.1.1:8000 check cookie s1
    server portal2 10.0.1.2:8000 check cookie s2
```

### Database HA

Use PostgreSQL replication or managed database:

```bash
# AWS RDS example
DD_DATABASE_URL=postgresql://user:pass@portal-db.cluster-xxx.us-east-1.rds.amazonaws.com:5432/defectdojo
```

---

## Backup & Restore

### Automated Backup

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR=/var/backups/kekkai-portal
DATE=$(date +%Y%m%d_%H%M%S)

# Backup database
docker compose exec -T postgres pg_dump -U defectdojo defectdojo | gzip > "$BACKUP_DIR/db_$DATE.sql.gz"

# Backup tenant store
cp /var/lib/kekkai-portal/tenants.json "$BACKUP_DIR/tenants_$DATE.json"

# Backup uploads
tar -czf "$BACKUP_DIR/uploads_$DATE.tar.gz" /var/lib/kekkai-portal/uploads/

# Retention: keep last 30 days
find "$BACKUP_DIR" -mtime +30 -delete
```

### Restore

```bash
#!/bin/bash
# restore.sh

BACKUP_DATE=$1  # e.g., 20260130_101530

# Stop services
docker compose down

# Restore database
gunzip -c "/var/backups/kekkai-portal/db_$BACKUP_DATE.sql.gz" | \
  docker compose exec -T postgres psql -U defectdojo defectdojo

# Restore tenant store
cp "/var/backups/kekkai-portal/tenants_$BACKUP_DATE.json" /var/lib/kekkai-portal/tenants.json

# Restore uploads
tar -xzf "/var/backups/kekkai-portal/uploads_$BACKUP_DATE.tar.gz" -C /

# Restart services
docker compose up -d
```

---

## Monitoring

### Health Checks

```bash
# Portal health
curl -f http://localhost:8000/api/v1/health

# DefectDojo health
curl -f http://localhost:8080/

# All services
docker compose ps --format "table {{.Name}}\t{{.Status}}"
```

### Log Aggregation

Forward logs to your SIEM:

```yaml
# docker-compose.override.yml
services:
  portal:
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://siem.example.com:514"
        tag: "kekkai-portal"
```

### Metrics

Expose Prometheus metrics:

```bash
PORTAL_METRICS_ENABLED=true
PORTAL_METRICS_PORT=9090
```

---

## Troubleshooting

### Services Not Starting

```bash
# Check logs
docker compose logs portal
docker compose logs defectdojo

# Check resource usage
docker stats
```

### Database Connection Failed

```bash
# Test database connectivity
docker compose exec portal python -c "
import psycopg2
conn = psycopg2.connect('postgresql://defectdojo:xxx@postgres:5432/defectdojo')
print('Connected!')
"
```

### Certificate Issues

```bash
# Verify certificate
openssl x509 -in ./certs/portal.crt -text -noout

# Test TLS connection
openssl s_client -connect portal.example.com:443
```

### Performance Issues

```bash
# Check container resources
docker stats

# Increase resources in compose
services:
  portal:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
```

---

## Upgrade Procedure

### Pre-Upgrade

1. Backup database and configuration
2. Review changelog for breaking changes
3. Test upgrade in staging environment

### Upgrade Steps

```bash
# Pull new images
docker compose pull

# Stop services
docker compose down

# Start with new images
docker compose up -d

# Run migrations (if any)
docker compose exec portal python manage.py migrate

# Verify
docker compose ps
curl -f http://localhost:8000/api/v1/health
```

### Rollback

```bash
# Stop services
docker compose down

# Restore from backup
./restore.sh BACKUP_DATE

# Start with previous images
docker compose up -d
```

---

## Related Documentation

- [SAML 2.0 Setup](saml-setup.md) - Configure SSO
- [RBAC Configuration](rbac.md) - Access control setup
- [Multi-Tenant Architecture](multi-tenant.md) - Tenant isolation
- [CLI-Portal Sync](cli-sync.md) - Connect CLI to Portal
- [Operations Guide](../ops/backup-restore.md) - Backup procedures
