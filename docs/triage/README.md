# Kekkai Triage

Interactive terminal UI for reviewing and triaging security findings.

## Overview

`kekkai triage` provides a keyboard-driven interface to review findings from `kekkai scan`, mark false positives, and generate `.kekkaiignore` files for future scans.

## Quick Start

```bash
# Run a scan first
kekkai scan --output findings.json

# Launch the triage TUI
kekkai triage --input findings.json
```

## Features

- **Keyboard Navigation**: Review findings without leaving your terminal
- **State Management**: Mark findings as Confirmed, False Positive, or Deferred
- **Ignore File Generation**: Auto-generate `.kekkaiignore` for false positives
- **Audit Logging**: Track all triage decisions with timestamps
- **Filtering**: Filter by severity, scanner, or triage state

## Usage

### Basic Usage

```bash
# Triage findings from default kekkai-report.json
kekkai triage

# Triage from specific file
kekkai triage --input scan-results.json

# Specify output ignore file
kekkai triage --input findings.json --output .kekkaiignore
```

### Keyboard Controls

| Key | Action |
|-----|--------|
| `↑` / `k` | Move up |
| `↓` / `j` | Move down |
| `Enter` | View finding details |
| `c` | Mark as Confirmed |
| `f` | Mark as False Positive |
| `d` | Mark as Deferred |
| `n` | Add notes |
| `s` | Save ignore file |
| `q` | Quit |

## Triage States

| State | Description | Action |
|-------|-------------|--------|
| **Pending** | Not yet reviewed | Default state |
| **Confirmed** | Valid security issue | Requires remediation |
| **False Positive** | Not a real issue | Added to `.kekkaiignore` |
| **Deferred** | Valid but postponed | Tracked for later |

## Ignore File Format

When you mark findings as false positives, Kekkai generates a `.kekkaiignore` file:

```
# Kekkai Ignore File
# Generated by kekkai triage

# False positive: Test file with intentional vulnerability
semgrep:python.lang.security.audit.dangerous-system-call:tests/test_app.py

# Not applicable: Internal-only endpoint
trivy:CVE-2023-12345:requirements.txt
```

### Pattern Format

```
<scanner>:<rule_id>:<file_path>
```

- **scanner**: `trivy`, `semgrep`, or `gitleaks`
- **rule_id**: The specific rule or CVE
- **file_path**: Optional file path for targeted ignores

## Audit Log

All triage decisions are logged to `.kekkai-audit.json`:

```json
{
  "decisions": [
    {
      "finding_id": "abc123",
      "state": "false_positive",
      "reason": "Test file with intentional vulnerability",
      "timestamp": "2024-01-15T10:30:00Z",
      "user": "developer"
    }
  ]
}
```

## Integration with CI/CD

Use the ignore file in CI pipelines:

```bash
# Scan respects .kekkaiignore automatically
kekkai scan --ci --fail-on high
```

The ignore file is read automatically from the repository root.

## Severity Levels

Findings are categorized by severity:

| Severity | Color | Description |
|----------|-------|-------------|
| Critical | Red | Immediate action required |
| High | Orange | Should be fixed soon |
| Medium | Yellow | Fix when possible |
| Low | Blue | Consider fixing |
| Info | Gray | Informational only |

## Tips

1. **Review Critical/High first**: Use severity filtering to prioritize
2. **Add notes**: Document why something is a false positive
3. **Commit .kekkaiignore**: Share triage decisions with your team
4. **Review periodically**: Re-triage when dependencies update

## Troubleshooting

### TUI doesn't display correctly

Ensure you're using a terminal that supports ANSI colors and Unicode:
- macOS: Terminal.app, iTerm2
- Linux: GNOME Terminal, Konsole
- Windows: Windows Terminal, PowerShell 7+

### Findings not loading

Check that your input file is valid JSON with the expected format:

```json
{
  "findings": [
    {
      "id": "...",
      "title": "...",
      "severity": "high",
      "scanner": "semgrep"
    }
  ]
}
```

Or as a flat array:

```json
[
  {
    "id": "...",
    "title": "...",
    "severity": "high",
    "scanner": "semgrep"
  }
]
```

## See Also

- [CI Mode Guide](../ci/ci-mode.md) - Using triage results in CI
- [Scan Documentation](../README.md) - Running scans
- [Policy Engine](../ci/ci-mode.md#policy-configuration) - Configuring thresholds
